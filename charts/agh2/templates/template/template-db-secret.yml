{{- if and .Values.template.enabled .Values.template.secret.enabled .Values.template.secret.db.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.template.secret.db.secretName }}
  labels:
    {{- include "AGH2.labels" . | nindent 4 }}
stringData:
  DB_CONN_STR: {{ include "connection-string"
    (
      dict
        "db" (
          merge
            .Values.template.secret.db
            .Values.db.connection
            (
              dict
                "password" (
                  include "specify-password"
                    (
                      dict
                        "domain" (default .Values.ingress.host "app.argushack.com")
                        "token" .Values.captain.secret.keygen.apiToken
                        "prefix" .Values.template.secret.db.secretName
                    )
                )
            )
        )
        "context" $
    ) | quote }}
{{- end }}
